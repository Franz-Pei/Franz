package com.dxfx.client;

import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.locks.Condition;
import java.util.concurrent.locks.Lock;
import java.util.concurrent.locks.ReentrantLock;

import com.dxfx.client.param.Response;



public class DefaultFuture {
	
	public final static ConcurrentHashMap<Long,DefaultFuture>allDefaultFuture = new ConcurrentHashMap<Long,DefaultFuture>();
	
	final Lock lock = new ReentrantLock();
	public Condition condition = lock.newCondition();
	private Response response;
	
	
	public DefaultFuture(ClientRequest request) {
		// TODO Auto-generated constructor stub
		allDefaultFuture.put(request.getId(),this);
	}

	//ä¸»çº¿ç¨‹è·å–ä¿¡æ¯
	public Response get() {
		lock.lock();
		try {
			while(!done()) {
				condition.await();
			}
			condition.await();
		}catch(Exception e) {
			e.printStackTrace();
		}finally {
			lock.unlock();
		}
		return this.response;
	}
	
	public static void recive(Response response) {
	    if (response == null || response.getId() == null) {
	        System.err.println("å“åº”æˆ–å“åº”IDä¸ºnull");
	        return;
	    }
	    
	    System.out.println("æ”¶åˆ°å“åº”ï¼ŒID: " + response.getId());
	    DefaultFuture df = allDefaultFuture.get(response.getId());
	    
	    if(df != null) {
	        Lock lock = df.lock;
	        lock.lock();
	        try {
	            df.setResponse(response);
	            df.condition.signal();
	            // ğŸ”§ å…³é”®ä¿®æ”¹ï¼šç§»é™¤æ—¶ä½¿ç”¨responseçš„ID
	            allDefaultFuture.remove(response.getId());  // ä¿®æ”¹è¿™è¡Œï¼
	            System.out.println("æˆåŠŸå¤„ç†å“åº”ï¼ŒID: " + response.getId());
	        } catch(Exception e) {
	            e.printStackTrace();
	        } finally {
	            lock.unlock();
	        }
	    } else {
	        System.err.println("æ‰¾ä¸åˆ°å¯¹åº”çš„DefaultFutureï¼ŒID: " + response.getId());
	    }
	}
	
	

	public Response getResponse() {
		return response;
	}

	public void setResponse(Response response) {
		this.response = response;
	}

	private boolean done() {
		// TODO Auto-generated method stub
		if(this.response!=null) {
			return true;
		}
		return false;
	}
}
